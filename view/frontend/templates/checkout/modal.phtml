<?php

declare(strict_types = 1);

/** @var \Magento\Framework\View\Element\Template $block */
/** @var \Hyva\Theme\ViewModel\HyvaCsp $hyvaCsp */

?>

<div id="twint-checkout-modal"
     x-data="twintCheckoutModal"
     x-init="initialize"
     x-cloak
     x-spread="overlay"
     x-bind="overlay"
     class="fixed inset-0 flex items-center justify-center text-left bg-black bg-opacity-50" style="z-index: 40;">
    <div x-ref="dialog"
         role="dialog"
         class="twint text-16 twint-modal-content-box"
         data-role="modal"
         data-type="<%- data.type %>"
         tabindex="0">
        <div data-role="focusable-start" tabindex="0"></div>
        <div class="modal-inner-wrap twint tw-modal"
             data-role="focusable-scope">
            <header class="twint-modal-header sticky top-0 flex justify-between items-center bg-white">
                <img class="tw-logo hidden md:block ml-4" src="<?= $block->getViewFileUrl('Twint_Magento::images/twint_logo.png') ?>" alt="<?= __("TWINT Logo"); ?>">
                <button @click="hide"
                        id="tw-close"
                        class="tw-close flex items-center justify-between sm:justify-start mx-4"
                        data-role="closeBtn"
                        type="button">
                    <span class="order-last sm:order-first"><?= __('Cancel checkout') ?></span>
                    <svg class="mr-3 md:mr-0 md:ml-3" width="14" height="13" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1.40001 12.8078L0.692261 12.1L6.29226 6.50001L0.692261 0.900011L1.40001 0.192261L7.00001 5.79226L12.6 0.192261L13.3078 0.900011L7.70776 6.50001L13.3078 12.1L12.6 12.8078L7.00001 7.20776L1.40001 12.8078Z" fill="#1C1B1F"/>
                    </svg>
                </button>
            </header>
            <div id="twint-modal-content" class="twint-modal-content p-0 md:p-4" data-role="content"></div>
        </div>
        <div data-role="focusable-end" tabindex="0"></div>
    </div>

    <script>
        'use strict';

        function twintCheckoutModal() {
            return Object.assign(
                hyva.modal(),
                {
                    mode: 'express',
                    initialize() {
                        window.addEventListener('twint-modal-open', (event) => {
                            const response = event.detail.response;
                            const mode = event.detail.mode;

                            if (mode) this.mode = mode;

                            if (!response) return;

                            this.processModal(response);
                        });

                        const url = new URL(window.location);
                        const showMiniCart = url.searchParams.get('showMiniCart');

                        if (showMiniCart) {
                            url.searchParams.delete('showMiniCart');
                            window.history.replaceState({}, '', url);
                            window.dispatchEvent(new CustomEvent('toggle-cart'));
                        }
                    },

                    processModal(response) {
                        if (response.showMiniCart) {
                            const url = new URL(window.location);
                            url.searchParams.set('showMiniCart', '1');
                            window.location = url.toString();
                        }

                        if (!response.success) {
                            console.error('TWINT: Failed to process modal', response);
                            return;
                        }

                        if (response.backUrl) {
                            window.location = response.backUrl;
                            return;
                        }

                        if (response.reload) {
                            window.location.reload();
                            return;
                        }

                        this.config = response;
                        this.renderModal();
                        this.registerCancelOrder();
                        this.registerMonitorOrder();
                        this.show();

                        window.dispatchEvent(new CustomEvent('twint-stop-loading'));
                    },

                    // Refactored helper methods for maintainability
                    getModalContent() {
                        return document.getElementById('twint-modal-content');
                    },

                    renderModal() {
                        const modalContent = this.getModalContent();
                        const config = this.config;

                        if (!modalContent || !config) return;
                        modalContent.innerHTML = config.modal;

                        this.ensureBaseStates();
                        this.updateAmountsAndToken();
                        this.setupQrCode();

                        // Initialize token copier (replaces clipboard.js)
                        this.initTokenCopier();
                        this.resetTokenCopierUi();

                        // Initialize mobile connectors (Android/iOS)
                        this.initMobileConnectors();
                    },

                    ensureBaseStates() {
                        const modalContent = this.getModalContent();
                        const qrModal = modalContent ? modalContent.querySelector('#qr-modal-content') : null;
                        if (qrModal) qrModal.style.display = 'block';
                        const toPay = modalContent ? modalContent.querySelector('.to-pay') : null;
                        if (toPay) toPay.style.display = 'block';
                        const onSuccess = modalContent ? modalContent.querySelector('.on-success') : null;
                        if (onSuccess) onSuccess.style.display = 'none';
                        const onFailed = modalContent ? modalContent.querySelector('.on-failed') : null;
                        if (onFailed) onFailed.style.display = 'none';
                    },

                    updateAmountsAndToken() {
                        const modalContent = this.getModalContent();
                        const config = this.config || {};
                        if (!modalContent) return;
                        const amountEl = modalContent.querySelector('#twint-amount');
                        if (amountEl) amountEl.innerHTML = config.amount;
                        const tokenInput = modalContent.querySelector('#qr-token');
                        if (tokenInput) tokenInput.value = config.token;
                    },

                    setupQrCode() {
                        const modalContent = this.getModalContent();
                        const config = this.config || {};
                        if (!modalContent) return;
                        const qr = modalContent.querySelector('#qrcode');
                        if (!qr) return;
                        qr.innerHTML = '';
                        if (typeof QRCode !== 'undefined') {
                            new QRCode(qr, {
                                text: config.token,
                                width: 300,
                                height: 300,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        } else {
                            console.error('TWINT: QRCode is not defined');
                        }
                    },

                    updateUiState({ toPay = null, onSuccess = null, onFailed = null } = {}) {
                        const modalContent = this.getModalContent();
                        if (!modalContent) return;
                        const toPayEl = modalContent.querySelector('.to-pay');
                        const onSuccessEl = modalContent.querySelector('.on-success');
                        const onFailedEl = modalContent.querySelector('.on-failed');
                        if (toPayEl && toPay !== null) toPayEl.style.display = toPay;
                        if (onSuccessEl && onSuccess !== null) onSuccessEl.style.display = onSuccess;
                        if (onFailedEl && onFailed !== null) onFailedEl.style.display = onFailed;
                    },

                    handleMonitorResponse(response) {
                        if (!response || response.finish !== true) return;
                        if (this.monitorTimer) {
                            clearInterval(this.monitorTimer);
                            this.monitorTimer = null;
                        }

                        return this.mode === 'express' ? this.handleExpressResult(response) : this.handleRegularResult(response);
                    },

                    handleExpressResult(response) {
                        if (response.status > 0) {
                            this.showExpressSuccess(response.order);
                            return;
                        }

                        if (response.status  === -2){
                            return this.onFailed();
                        }

                        return this.onCancelled();
                    },

                    handleRegularResult(response) {
                        // Regular checkout
                        if (response.paid !== true) {
                            return this.onFailed();
                        }

                        window.location = '<?= $block->getUrl('checkout/onepage/success') ?>';
                    },

                    // Token copier (native, replaces clipboard.js)
                    initTokenCopier() {
                        try {
                            const modalContent = this.getModalContent();
                            if (!modalContent) return;
                            const btn = modalContent.querySelector('#tw-copy');
                            const input = modalContent.querySelector('#qr-token');
                            if (!btn || !input) return;
                            // Ensure only one listener per render
                            btn.addEventListener('click', (e) => this.onCopyClick(e, input, btn), { passive: false });
                        } catch (e) {
                            console.error('TWINT: Failed to init token copier', e);
                        }
                    },

                    resetTokenCopierUi() {
                        const modalContent = this.getModalContent();
                        if (!modalContent) return;
                        const btn = modalContent.querySelector('#tw-copy');
                        const input = modalContent.querySelector('#qr-token');
                        if (!btn || !input) return;
                        btn.innerText = 'Copy code';
                        btn.classList.remove('copied');
                        btn.classList.remove('border-green-500');
                        btn.classList.remove('text-green-500');
                        try { input.disabled = true; } catch (e) {}
                    },

                    async onCopyClick(event, input, btn) {
                        try {
                            if (event && event.preventDefault) event.preventDefault();
                            if (!input || !btn) return;
                            input.disabled = false;
                            const text = input.value || '';
                            await this.copyToClipboard(text, input);
                            this.onCopySuccess(btn, input);
                        } catch (e) {
                            this.onCopyError(btn, e);
                        }
                    },

                    copyToClipboard(text, inputEl) {
                        return new Promise((resolve, reject) => {
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(text).then(resolve).catch(reject);
                                return;
                            }
                            try {
                                // Fallback using a temporary textarea
                                const textarea = document.createElement('textarea');
                                textarea.value = text;
                                textarea.style.position = 'fixed';
                                textarea.style.left = '-9999px';
                                document.body.appendChild(textarea);
                                textarea.focus();
                                textarea.select();
                                const successful = document.execCommand('copy');
                                document.body.removeChild(textarea);
                                if (successful) {
                                    resolve();
                                } else {
                                    reject(new Error('execCommand copy failed'));
                                }
                            } catch (err) {
                                try {
                                    // As a last fallback try selecting the input element itself
                                    if (inputEl) {
                                        inputEl.focus();
                                        inputEl.select();
                                        const ok = document.execCommand('copy');
                                        window.getSelection && window.getSelection().removeAllRanges();
                                        if (ok) return resolve();
                                    }
                                } catch (_) {}
                                reject(err);
                            }
                        });
                    },

                    onCopySuccess(btn, input) {
                        try {
                            if (document && document.activeElement) {
                                document.activeElement.blur();
                            }
                            if (window.getSelection) {
                                const sel = window.getSelection();
                                if (sel && sel.removeAllRanges) sel.removeAllRanges();
                            }
                        } catch (e) {}
                        btn.innerText = 'Copied!';
                        btn.classList.add('copied');
                        btn.classList.add('border-green-500');
                        btn.classList.add('text-green-500');
                        try { input.disabled = true; } catch (e) {}
                    },

                    onCopyError(btn, err) {
                        console.error('TWINT: Copy failed', err);
                        // Keep default UI; optionally could show an error state
                    },

                    // Mobile connectors initialization
                    initMobileConnectors() {
                        try {
                            this.initAndroidConnector();
                            this.initIosConnector();
                        } catch (e) {
                            console.error('TWINT: Failed to init mobile connectors', e);
                        }
                    },

                    // Android: auto open app deeplink via button with id 'twint-addroid-button'
                    initAndroidConnector() {
                        const modalContent = this.getModalContent();
                        if (!modalContent) return;
                        const btn = modalContent.querySelector('#twint-addroid-button');
                        if (!btn) return;

                        const twintGuides = modalContent.querySelector('#twint-guides');
                        if (twintGuides) twintGuides.classList.add('hidden');

                        const templateHref = btn.getAttribute('data-href');
                        if (!templateHref) return;

                        const href = templateHref.replace('--TOKEN--', this.config.token || '');
                        btn.href = href;

                        // Auto-click to open app and then show QR code fallback
                        try {
                            // Use setTimeout to ensure DOM is ready
                            setTimeout(() => {
                                btn.click();
                                this.showMobileQrCode();
                            }, 0);
                        } catch (e) {
                            // If click fails, still show QR
                            this.showMobileQrCode();
                        }
                    },

                    // iOS: bind bank images and select list under '#twint-ios-container'
                    initIosConnector() {
                        const modalContent = this.getModalContent();
                        if (!modalContent) return;
                        const container = modalContent.querySelector('#twint-ios-container');
                        if (!container) return;

                        const twintGuides = modalContent.querySelector('#twint-guides');
                        if (twintGuides) twintGuides.classList.add('hidden');

                        // Bind bank images
                        const banks = container.querySelectorAll('img[data-link]');
                        if (banks && banks.forEach) {
                            banks.forEach((bank) => {
                                bank.addEventListener('touchend', (event) => {
                                    const link = bank.getAttribute('data-link');
                                    this.openAppBank(link);
                                }, { passive: true });
                            });
                        }

                        // Bind select change
                        const select = container.querySelector('select');
                        if (select) {
                            try { select.selectedIndex = 0; } catch (e) {}
                            select.addEventListener('change', (event) => {
                                const el = event.target;
                                let link = '';
                                try {
                                    link = el.options[el.selectedIndex].value;
                                } catch (e) {}
                                this.openAppBank(link);
                            });
                        }

                        // Ensure QR code block for mobile is visible as fallback
                        this.showMobileQrCode();
                    },

                    openAppBank(link) {
                        if (!link) return;
                        const token = this.config && this.config.token ? this.config.token : '';
                        link = link.replace('--TOKEN--', token);

                        try {
                            window.location.replace(link);

                            const checkLocation = setInterval(() => {
                                try {
                                    if (window.location.href !== link) {
                                        this.showMobileQrCode();
                                    }
                                } catch (e) {
                                    // ignore
                                }
                                clearInterval(checkLocation);
                            }, 2000);
                        } catch (e) {
                            // If navigation fails, show QR fallback
                            this.showMobileQrCode();
                        }
                    },

                    showMobileQrCode() {
                        // Mimic legacy connector.showMobileQrCode behavior
                        const blocks = document.querySelectorAll('.default-hidden');
                        if (!blocks) return;
                        blocks.forEach((block) => {
                            block.classList.remove('hidden');
                        });
                    },

                    registerCancelOrder() {
                        if (!this.originalHide) {
                            this.originalHide = this.hide;
                            this.hide = (event) => {
                                if (event === undefined) return; // Prevent click.away closing the modal

                                this.originalHide.call(this, event);

                                const cancelUrl = '<?= $block->getUrl('twint/payment/cancel') ?>' + '?id=' + this.config.pairingId;

                                fetch(cancelUrl).catch(error => console.error('Error:', error));
                            }
                        }
                    },

                    registerMonitorOrder() {
                        this.monitorTimer = null;
                        const origHide = this.hide;
                        let monitorUrl;

                        if (this.mode === 'express') {
                            monitorUrl = '<?= $block->getUrl('twint/express/status') ?>' + '?id=' + this.config.pairingId;
                        } else {
                            monitorUrl = '<?= $block->getUrl('twint/regular/status') ?>' + '?id=' + this.config.pairingId;
                        }

                        const checkStatus = () => {
                            fetch(monitorUrl)
                                .then(resp => resp.json())
                                .then(response => this.handleMonitorResponse(response))
                                .catch(error => console.error('Failed to check status:', error));
                        };

                        this.monitorTimer = setInterval(checkStatus, 2000);

                        this.hide = (value) => {
                            origHide.call(this, value);
                            if (this.monitorTimer) {
                                clearInterval(this.monitorTimer);
                                this.monitorTimer = null;
                            }
                        };
                    },

                    showExpressSuccess(order) {
                        this.updateUiState({ toPay: 'none', onSuccess: 'block', onFailed: 'none' });

                        const modal = this.getModalContent();
                        const success = modal.querySelector('.on-success');

                        success.style.display = 'block';

                        const span = success.querySelector('span');
                        span.innerHTML = order;

                        const label = document.querySelector('#tw-close-' + this.elementId + ' span');
                        label.innerHTML = 'Continue shopping';

                        // Remove cancel order action on Hide button.
                        this.hide = (value) => {
                            window.location.reload();
                        };
                    },

                    onFailed() {
                        this.updateUiState({ toPay: 'none', onSuccess: 'none', onFailed: 'block' });
                    },
                }
            )
        }

        window.addEventListener(
            'alpine:init',
            () => Alpine.data('twintCheckoutModal', twintCheckoutModal),
            {once: true}
        )

        window.addEventListener(
            'init-external-scripts',
            () => {
                const script = document.createElement('script')
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                script.type = 'text/javascript';
                document.head.append(script);
            },
            {passive: true}
        );
    </script>
    <?php $hyvaCsp->registerInlineScript() ?>
</div>
